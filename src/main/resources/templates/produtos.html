<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Produtos</title>
    <link rel="icon" href="./img/icon.png" type="png">
    <link rel="icon" th:href="@{/img/icon.png}" type="image/png">
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link th:href="@{/css/bootstrap.min.css}" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>

<body class="background">
    <!--header-->
    <header>
        <div class="container-menu">
            <div class="logo-topo">
                <img th:src="@{/img/LogoMarca.png}" alt="logo marca">
            </div>
            <div class="titulo">
                <h1>Produtos</h1>
            </div>
        </div>
    </header>
    <!--Fim header-->
    <!--main-->
    <main>
        <!--section-->
        <section>
            <!--container-produtos-->
            <div class="container-produtos">
                <div class="formulario-produtos-um">
                    <div id="quantidade">Quantidade do produto:</div>
                    <form id="formularioProduto">
                        <input id="codigo" type="text"><br>
                        <label>Nome:</label>
                        <input id="nome" type="text" th:field="${produto.nomeProduto}" required><br>
                        <label>Valor de compra:</label>
                        <input id="valorCompra" type="text" th:field="${produto.valorCompra}" required><br>
                        <label>Valor de venda:</label>
                        <input id="valorVenda" type="text" th:field="${produto.valorVenda}" required><br>
                        <label>Modelo:</label>
                        <input id="modelo" type="text" th:field="${produto.modelo}" required><br>
                        <label>número da nota fiscal:</label>
                        <input id="fiscal" type="text" th:field="${produto.notaFiscal}" required><br>
                        <label>Data de aquisição:</label>
                        <input id="data" type="date" required min="1900-01-01" max="2100-12-31"
                            th:field="${produto.dataAquisicao}"><br>
                        <label>Fabricante:</label>
                        <input id="fabricante" type="text" th:field="${produto.fabricante}" required><br>
                        <div id="status">Status:</div>
                        <br>
                        <input type="hidden" id="produtoId" name="id" value="${produto.id != null ? produto.id : ''}" />
                    </form>
                    <div id="texto-area"><label>Descrição técnica:</label>
                        <textarea id="descricao" class="form-control" th:field="${produto.descricaoTecnica}"
                            required></textarea>
                    </div>
                    <div class="botoes-formulario">

                        <button type="button" class="form-control voltar" id="voltar"
                            onclick="window.location.href = '/menu'">Voltar</button>
                        <button type="button" class="form-control" id="salvarProduto">Salvar</button>
                        <button type="submit" class="form-control" id="atualizarProduto">Alterar</button>
                        <button type="button" class="form-control" id="btn-limpar">Limpar</button>
                    </div>

                </div>
                <div class="formulario-produtos-dois">
                    <div id="prateleiraDiv"><label id="label-prateleira" for="prateleira" required>Número da
                            prateleira:</label>
                        <select id="prateleira" required>
                            <option value="">Selecione um item</option>
                            <option value="1" th:field="${produto.localArmazenamento.numeroPrateleira}">1</option>
                            <option value="2" th:field="${produto.localArmazenamento.numeroPrateleira}">2</option>
                            <option value="3" th:field="${produto.localArmazenamento.numeroPrateleira}">3</option>
                            <option value="4" th:field="${produto.localArmazenamento.numeroPrateleira}">4</option>
                        </select><br>
                    </div>

                    <div id="LocalPrateleiraDiv"><label for="localPrateleira" required>Número do local da
                            prateleira:</label>
                        <select id="localPrateleira" required>
                            <option value="">Selecione um item</option>
                            <option value="1" th:field="${produto.localArmazenamento.numeroLocalPrateleira}">1</option>
                            <option value="2" th:field="${produto.localArmazenamento.numeroLocalPrateleira}">2</option>
                            <option value="3" th:field="${produto.localArmazenamento.numeroLocalPrateleira}">3</option>
                            <option value="4" th:field="${produto.localArmazenamento.numeroLocalPrateleira}">4</option>
                        </select><br>
                    </div>


                    <div id="categoriaDiv"><label for="categoria">Categoria:</label>
                        <select id="categoria" required>
                            <option value="">Selecione um item</option>
                            <option value="Componentes de hardware" th:field="${produto.categoria.nome}">Componentes de
                                hardware</option>
                            <option value="Conectividade e redes" th:field="${produto.categoria.nome}">Conectividade e
                                redes</option>
                            <option value="Dispositivos computacionais" th:field="${produto.categoria.nome}">
                                Dispositivos computacionais</option>
                            <option value="Periférico" th:field="${produto.categoria.nome}">Periférico</option>
                            <option value="Suprimentos de impressora" th:field="${produto.categoria.nome}">Suprimentos
                                de impressora</option>
                        </select><br>
                    </div>
                    <div><label>Pesquisar:</label>
                        <div class="radio-group">
                            <label><input id="radio1" class="radio" type="radio" name="pesquisar" value="codigo">
                                Código</label>
                            <label><input id="radio2" class="radio" type="radio" name="pesquisar" value="nome">
                                Nome</label>
                            <label><input id="radio3" class="radio" type="radio" name="pesquisar" value="modelo">
                                Modelo</label><br>
                            <label><input id="radio4" class="radio" type="radio" name="pesquisar" value="fabricante">
                                Fabricante</label>
                            <label><input id="radio5" class="radio" type="radio" name="pesquisar"
                                    value="disponibilidade"> Disponibilidade</label>
                            <label><input id="radio6" class="radio" type="radio" name="pesquisar" value="devolvido">
                                Devolvido</label><br>
                            <label><input id="radio7" class="radio" type="radio" name="pesquisar" value="categoria">
                                Categoria</label><br>
                        </div>
                    </div>

                    <div> <select id="item-categoria">
                            <option>Selecione uma categoria</option>
                            <option value="Componentes de hardware">Componentes de hardware</option>
                            <option value="Conectividade e redes">Conectividade e redes</option>
                            <option value="Dispositivos computacionais">Dispositivos computacionais</option>
                            <option value="Periférico">Periférico</option>
                            <option value="Suprimentos de impressora">Suprimentos de impressora</option>
                        </select><br></div>
                    <input id="campo" type="text" placeholder="Digite o valor para busca" style="display: none;">


                    <button id="search-button" class="form-control" onclick="buscarProduto(event)">Buscar</button>
                </div>
            </div>
            </div>
            </div>
            <!--Fim container-produtos-->
            <!--container-tabela-->
            <div class="container-tabela table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Código do Produto</th>
                            <th>Nome</th>
                            <th>Valor de Compra</th>
                            <th>Valor de Venda</th>
                            <th>Quantidade</th>
                            <th>Modelo</th>
                            <th>Nota Fiscal</th>
                            <th>Data de Aquisição</th>
                            <th>Fabricante</th>
                            <th>Descrição Técnica</th>
                            <th>Categoria</th>
                            <th>Prateleira</th>
                            <th>Local de Armazenamento</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="tabela-reservas">
                    </tbody>
                </table>

            </div>
            <!--Fim container-tabela-->
        </section>
        <!--Fim section-->
    </main>
    <!--Fim main-->
    <script>
        $(".radio").on("change", function () {
            var criterio = $(this).val();
            if (criterio === "categoria") {
                $("#campo").hide();
                $("#item-categoria").show();
            } else {
                $("#campo").show().val("").attr("placeholder", "Digite o valor para " + criterio);
                $("#item-categoria").hide();
            }
            if (criterio === "devolvido") {
                alert("Digite o código do produto devolvido");
            } else if (criterio === "disponibilidade") {
                alert("Por favor, digite: Disponível");
            }
        });
        $(document).ready(function () {

        });
        // Função para listar os produtos
        function listarProdutos() {
            $.ajax({
                type: "GET",
                url: "/listar-produtos",  // Verifique o caminho correto aqui
                dataType: "json",
                cache: false,  // Desabilitar cache pode ser útil
                success: function (produtos) {
                    console.log(produtos);  // Verifique se os dados estão sendo recebidos corretamente
                    $("#tabela-produto").empty();  // Limpa a tabela antes de preencher com os novos dados

                    // Verifica se o retorno não está vazio
                    if (produtos && produtos.length > 0) {
                        produtos.forEach(function (produto) {
                            var dataAquisicaoFormatada = "";

                            if (produto.dataAquisicao) {
                                var data = new Date(produto.dataAquisicao + "T00:00:00");
                                dataAquisicaoFormatada = data.toLocaleDateString('pt-BR', {
                                    day: '2-digit',
                                    month: '2-digit',
                                    year: 'numeric'
                                });
                            }

                            var linha = "<tr class='linha-produto' data-id='" + produto.id + "'>" +
                                "<td>" + produto.id + "</td>" +
                                "<td>" + produto.nomeProduto + "</td>" +
                                "<td>" + produto.valorCompra + "</td>" +
                                "<td>" + produto.valorVenda + "</td>" +
                                "<td>" + produto.quantidadeProduto + "</td>" +
                                "<td>" + produto.modelo + "</td>" +
                                "<td>" + produto.notaFiscal + "</td>" +
                                "<td>" + dataAquisicaoFormatada + "</td>" +
                                "<td>" + produto.fabricante + "</td>" +
                                "<td>" + produto.descricaoTecnica + "</td>" +
                                "<td>" + (produto.categoria ? produto.categoria.nome : "") + "</td>" +
                                "<td>" + (produto.localArmazenamento ? produto.localArmazenamento.numeroPrateleira : "") + "</td>" +
                                "<td>" + (produto.localArmazenamento ? produto.localArmazenamento.numeroLocalPrateleira : "") + "</td>" +
                                "<td>" + produto.statusProduto + "</td>" +
                                "</tr>";

                            // Adiciona cada linha à tabela
                            $("#tabela-reservas").append(linha);
                        });
                    } else {
                        alert("Nenhum produto encontrado.");
                    }
                },
                error: function (xhr, status, error) {
                    console.error("Erro ao carregar dados dos produtos:", error);  // Log do erro para depuração
                    alert("Erro ao carregar dados dos produtos.");
                }
            });
        }

        // Chama a função para listar os produtos quando a página for carregada
        $(document).ready(function () {
            listarProdutos();
        });
        $("#tabela-reservas").on("click", "tr.linha-produto", function () {
        var idProduto = $(this).data("id");  // Obtém o id do produto clicado
        $("#atualizarProduto").prop("disabled", false);
        $("#salvarProduto").prop("disabled", true);
        // Realiza a requisição AJAX para buscar o produto pelo ID
        $.ajax({
            url: "/buscar-produto",
            method: "GET",
            data: { id: idProduto },
            dataType: "json",
            success: function (response) {
                console.log(response);

                // Preenche os campos do formulário com os dados do produto
                $("#nome").val(response.nomeProduto || "");
                $("#valorCompra").val(response.valorCompra || "");
                $("#valorVenda").val(response.valorVenda || "");
                $("#modelo").val(response.modelo || "");
                $("#fiscal").val(response.notaFiscal || "");
                $("#data").val(response.dataAquisicao || "");
                $("#fabricante").val(response.fabricante || "");
                $("#descricao").val(response.descricaoTecnica || "");
                $("#prateleira").val(response.localArmazenamento?.numeroPrateleira || "");
                $("#localPrateleira").val(response.localArmazenamento?.numeroLocalPrateleira || "");
                $("#categoria").val(response.categoria?.nome || "");
                $("#status").text("Status: " + (response.statusProduto || "Desconhecido"));
                $("#quantidade").text("Quantidade do produto: " + (response.quantidadeProduto || "Desconhecido"));
                $("#produtoId").val(response.id);
            },
            error: function (xhr) {
                alert("Erro ao buscar produto.");
            }
        });
    });

        document.getElementById("codigo").hidden = true;

    </script>

    <script th:src="@{/js/produtoScript.js}"></script>

</body>

</html>